<!DOCTYPE html>
<html>
<head>
	<title>编辑优惠劵 - {part '/site.main.orgname'} - 云课 - 专业的在线学习平台</title>
	<meta name="title" content="{part '/site.main.orgname'} - 优惠管理 - 云课 - 专业的在线学习平台">
	<meta name="keywords" content="{part '/site.main.orgname'} - 云课 - Yunke K12 在线学习 直播 云课网 在线教育">
	<meta name="description" content="{part '/site.main.orgname'} - 云课(Yunke.com) -专业的K12在线学习平台。以直播授课为核心，打破时间与空间的界限，为教师高效教学、学生高效学习、家长高效管控及机构高效管理提供完美解决方案">
	{part "/site.main.header"}
</head>
<body>
	{part "/site.main.nav"}
	<section class="pd30">
		<div class="container">
			<div class="row">
				<!-- left menu -->
				{part "/org.main.menu.discount"}
				<!-- /left menu -->
				<!-- right -->
				<div class="right-main col-md-16 col-xs-20">
					<!-- path -->
					<div class="col-xs-20 col-md-20 pd0 fs14">
						<a href="/org.discount.listnew">优惠管理</a> &gt; 编辑优惠
					</div>
					<!-- /path -->
					<form id="SetupForm">
					<ul class="form-horizontal col-md-15 col-xs-20 p0 mt20" >
						<li class="form-group">
							<div class="control-label col-xs-6"><span class="cRed fb">*</span>名称：</div>
							<div class="col-xs-14 col-md-11 p0">
								<input type="text" disabled="disabled" id="discount_name" name="discount_name" placeholder class="col-md-12 col-xs-20 p0 required" data-tip="请输入折扣名称" data-valid="isNonEmpty" data-error="请输入折扣名称" data-status="0"><div class="tips"></div>
							</div>
						</li>
						<li class="form-group">
							<div class="control-label col-xs-6"><span class="cRed fb">*</span>规则类型：</div>
							<div class="col-xs-14 col-md-11 p0">
								<label><input type="radio" disabled="disabled" name="discount_type" value="1">满额减</label>
								<label><input type="radio" disabled="disabled" name="discount_type" value="2">打折</label>
								<div class="bg-gray col-xs-20 col-md-20  p5" id="disValue">
									满 <input type="text" disabled="disabled" size="5" name="min_fee" value=""> <span class="dType">减</span>  <input disabled="disabled" type="text" size="5"  name="discount_value" value=""> <span class="dVal">元</span>
								</div>
							</div>
						</li>
						<li class="form-group">
							<div class="control-label col-xs-6"><span class="cRed fb">*</span>优惠范围：</div>
							<div class="col-xs-14 col-md-11 pt5" id="selectArea">
								<input type="hidden" value="" name="pk_discount">
								<input type="hidden" value="1" name="object_type">
								<input type="hidden" value="all" name="object_id">
							</div>
						</li>
						<li class="form-group">
							<div class="control-label col-xs-6"><span class="cRed fb">*</span>使用限制：</div>
							<div class="col-xs-14 col-md-11 p0">
								<div class="col-xs-20 pd0">
									<span class="c-fl mt5 mr5 tar" style="width:60px">每个码限用 </span>
									<input type="text" name="total_num" disabled="disabled" size="5">
								</div>
							</div>
						</li>
						<li class="form-group">
							<div class="control-label col-xs-6"><span class="cRed fb">*</span>有限期：</div>
							<div class="col-xs-14 col-md-11 p0">
								<div class="col-xs-20 col-md-10 p0">
									<span class="c-fl mt5">开始时间：</span>
									<div class="timing">
										<input type="text" name="start_time" id="start_time"><i class="timing-arrow"></i>
									</div>
								</div>
								<div class="col-xs-20 col-md-10 p0">
									<span class="c-fl mt5">有效时长：</span>
									<select name="duration" id="duration">
										<option value="0">永久</option>
										<option value="365">一年</option>
										<option value="183">半年</option>
										<option value="90">90天</option>
										<option value="30">30天</option>
										<option value="7">7天</option>
									</select>
								</div>
							</div>
						</li>
						<li class="form-group">
							<div class="control-label col-xs-6">备注：</div>
							<div class="col-xs-14 col-md-11 p0">
								<textarea name="introduction" style="width:100%;" placeholder="最多30个字，有助于你区分设置不同的优惠券哦~"></textarea>
							</div>
						</li>
						<li class="form-group">
							<div class="control-label hidden-xs">&nbsp;</div>
							<div class="col-xs-20 tac p0">
								<a href="javascript:void(0);" class="btn mr10 p0">保存</a>
								<a href="javascript:void(0);" class="gray-btn p0">取消</a>
								<p class="col-xs-20 pd10">保存后，只有优惠范围、有效期和备注可再次编辑。</p>
							</div>
						</li>
					</ul>
					</form>
					<!-- /form -->
					<ul class="couponlist hidden-xs col-md-5 p0" id="couponList">
						<li class="coupon-item">
							<div class="coupon-main">
								<div class="coupon-type coupon-type-discount tac">
									<p class="c-price pt25 fb fs30"></p>
									<p class="c-fee fs16"></p>
									<p class="c-limit pt5"></p>
								</div>
								<div class="coupon-msg">
									<p class="pb5 choices-date"></p>
									<p class="pb5 expiry-date"></p>
									<p class="pb5">适用机构：{part '/site.main.orgname'}</p>
								</div>
							</div>
						</li>
					</ul>
				</div>
				<!-- /right -->
			</div>
		</div>
	</section>
<!-- layer -->
<ul id="range" class="p20 fs14" style="display:none">
	<li class="pb5">
		<div class="col-xs-5">&nbsp;</div>
		<label for="range-all"><input type="radio" checked value="all" name="range" id="range-all">全部课程</label>
	</li>
	<li class="pb5">
		<div class="col-xs-5">&nbsp;</div>
		<label for="range-course"><input type="radio" value="1" name="range" id="range-course">指定课程</label>
	</li>
	<li class="pb20">
		<div class="col-xs-5">&nbsp;</div>
		<label for="range-class"><input type="radio" value="3" name="range" id="range-class">指定分类课程</label>
	</li>
	<li class="pb5 tac">
		<button class="btn">下一步</button> <button class="gray-btn">取消</button>
	</li>
</ul>
<div id="course" style="display:none"></div>
<div id="classify" style="display:none"></div>
<script type="text/javascript" src="{utility_cdn::js('/assets_v2/js/ejs.min.js')}"></script>
<!--[if lt IE 9]>
<script type="text/javascript" src="/assets_v2/js/ie8/ejs.ie8.js"></script>
<![endif]-->
<script type="text/javascript" src="{utility_cdn::js('/assets_v2/js/jquery/jquery.validate.js')}"></script>
<link rel="stylesheet" type="text/css" href="{utility_cdn::css('/assets/libs/datetimepicker-master/jquery.datetimepicker.css')}">
<script type="text/javascript" src="{utility_cdn::js('/assets/libs/datetimepicker-master/jquery.datetimepicker.js')}"></script>
<script>
	var editId = location.hash.substring(1);
	$(function(){
		var couponList=$('#couponList');
		var CourseRange=$('#CourseRange');
		var SetupForm=$('#SetupForm');
		SetupForm.find('input[name="pk_discount"]').val(editId);
		$.ajax({
			type:"get",
			url: "/org/discount/EditDiscountCode",
			data:{ "pk_discount":editId },
			dataType:'json',
			success:function(r){
				if(r.error ){
					layer.msg('你查找的优惠劵不存在');
				}else{
					var d=r.data[0];
					if(!$.isEmptyObject(d["name"])){
						$('#discount_name').val(d["name"]);
					}
					SetupForm.find('[name="introduction"]').val(d["introduction"]);
					SetupForm.find('[name="object_type"]').val(d["object_type"]);
					SetupForm.find('[name="object_id"]').val(d["object_id"]);
					$('#start_time').val(d["starttime"].split(' ')[0]);
					SetupForm.find('[name="total_num"]').val(d["total_num"]);
					SetupForm.find('input[name="discount_type"][value="'+d["discount_type"]+'"]').attr('checked',true);
					$('#duration').find('option[value="'+d["duration"]+'"]').attr('selected',true);
					SetupForm.find('input[name="min_fee"]').val(d["min_fee"]);
					couponList.find('.c-fee').text('满'+d["min_fee"]+'元可用');
					couponList.find('.c-limit').text('可用'+d["total_num"]+'次');
					if(d['discount_type']=='2'){
						couponList.find('.coupon-type').removeClass('coupon-type-discount');
						couponList.find('.c-price').text(d["discount_value"]+'折');
						SetupForm.find('input[name="discount_value"]').val(d["discount_value"]);
						SetupForm.find('.dVal').text('折');
						SetupForm.find('.dType').text('打');
					}else{
						couponList.find('.c-price').text(d["discount_value"]+'元');
						SetupForm.find('input[name="discount_value"]').val(d["discount_value"]);
						SetupForm.find('.dVal').text('元');
					}
					if(d['object_type']=='3'){
						var _objHtml='<a id="CourseEdit">指定分类课程 <i class="choices-icon"></i></a>';
					}else if(d['object_type']=='1'){
						if(d['object_id']=='all'){
							var _objHtml='<a id="CourseEdit">全部课程 <i class="choices-icon"></i></a>';
						}else{
							var n=(d['object_id'].split(',')).length;
							var _objHtml='<a id="CourseEdit">指定'+n+'课程  <i class="choices-icon"></i></a>';
							cList();
						}
					}
					$('#selectArea').append(_objHtml);
					couponList.find('.choices-date').html('优惠范围：'+ _objHtml);
					couponList.find('.choices-date a').attr({ href:d["url"],target:"_blank" });
					if(d['duration'] == '0'){
						couponList.find('.expiry-date').text('有效期：永久');
					}else{
						couponList.find('.expiry-date').text('有效期：'+d['duration']+'天');
					}

				}
			}
		});

		$('#range').on('click','.btn',function(){
			var _selectedvalue=$('#range').find('input[name="range"]:checked').val();
			if(_selectedvalue != "3"){
				SetupForm.find('input[name="object_type"]').val('1');
				layer.closeAll();
				if(_selectedvalue =="all"){
					if($('.multiple-select').length!=0){
						$('.multiple-select').remove();
					}
					SetupForm.find('input[name="object_id"]').val('all');
					$('#CourseRange').hide();
					if(SetupForm.find('#CourseEdit').length==0){
						$('#selectArea').append('<a id="CourseEdit">全部课程<i class="choices-icon"></i></a>');
					}else{
						SetupForm.find('#CourseEdit').html('全部课程<i class="choices-icon"></i>');
					}
					couponList.find('.choices-date').text('优惠范围：全部课程');
				}else{
					selectCourse();
				}
			}else{
				layer.closeAll();
				selectCate();
			}
		});

		$('#range').on('click','.gray-btn',function(){
			layer.closeAll();
		});
		SetupForm.on('click','.gray-btn',function(){
			history.go(-1);
		});

		SetupForm.on('click','#CourseRange,#CourseEdit',function(){
			var object_type=$('#selectArea input[name="object_type"]').val();
			var object_id=$('#selectArea input[name="object_id"]').val();
			var w, h;
			if($(window).width() <= 768) {
				w = '90%';
				h = '220px';
			}else{
				w = '340px';
				h = '220px';
			}
			layer.open({
	            type: 1,
	            title:['优惠范围'],
	            area: [w ,h],
	            shadeClose: true,
	            content: $('#range'),
				success: function(){
					$('#range').find('input').removeAttr('checked');
					if(object_type == 1 && object_id == "all"){
						$('#range').find('input[value=all]').prop("checked",true);
					}else{
						$('#range').find('input[value='+object_type+']').prop("checked",true);
					}
  				}
	        });
		})


		SetupForm.on('click','.btn',function(event) {
			$.ajax({
		        type:"post",
		        url: "/org/discount/UpdateEditDiscountCode",
		        data:$('#SetupForm').serialize(),
		        dataType:'json',
		        success:function(r){
		            if(r.code==0){
						location.href = "/org.discount.listnew";
		            }
		        }
		    });
		});

		SetupForm.find('.timing-arrow').click(function(){
			$('#start_time').datetimepicker('show');
		})

		$("#start_time").datetimepicker({
			timepicker:false,
			format: 'Y-m-d',
		});


	});

	function selectCourse(){
		var w, h;
		if($(window).width() <= 768) {
			w = '90%';
			h = '530px';
		}else{
			w = '765px';
			h = '530px';
		}
		layer.open({
			type: 2,
			title:['选择课程'],
			area: [w ,h],
			shadeClose: true,
			content:'/org.discount.courseselect'
		});
	};

	function cList(){
		var _val=$('input[name="object_id"]').val();
		$.ajax({
			type:"post",
			url: '/org/discount/CourseListInfo',
			data:{ page:1,courseIds:_val },
			dataType:'json',
			success:function(r){
				var data = r.checkedCourseids;
				if(data.length > 0 ){
					var _ul=$('<ul class="multiple-select" style="width:60%;height:200px"></ul>');
					var _html="";
					for(var i=0;i<data.length;i++){
						_html= _html +'<li data-id="'+data[i].course_id+'">'+data[i].title+'</li>';
					}
					if($('#selectArea .multiple-select').length > 0){
						$('#selectArea .multiple-select').html(_html);
					}else{
						_ul.append(_html)
						$('#selectArea').append(_ul);
					}
				}else{
					//$('#multiple-left').unbind('scroll');
				}
			},
			complete:function(){
			},
			error: function(r){
				//page--;
			}
		});
	}

	function selectCate(){
		var w, h;
		if($(window).width() <= 768) {
			w = '90%';
			h = '230px';
		}else{
			w = '350px';
			h = '230px';
		}
		layer.open({
			type: 2,
			title:['优惠范围'],
			area: [w ,h],
			shadeClose: true,
			content:'/org.discount.cateselect'
		});
	}
</script>
{part "/site.main.footer"}
</body>
</html>
