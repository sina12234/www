<?php

class interface_user extends interface_base
{
	private static $gender = array(1=>'male',2=>'female');

    public function pageGetVerificationCode()
    {
        $this->v(
            [
                'mobile' => 1013,
                'type' => 1000
            ]
        );
		
		$type   = intval($this->paramsInfo['params']['type']);
		$mobile = $this->paramsInfo['params']['mobile'];
		
		if(!in_array($type,array(1,2,3))){
			$this->setMsg(1);
		}
		
        if (!utility_valid::mobile($mobile)) {
            $this->setMsg(1012);
        }

        if ($type == 1) {
            if (user_api::isRegister($mobile)) {
                $this->setMsg(2009);
            }
        }

		if ($type == 2) {
			$res = user_api::getUserIdByMobile($mobile);
			if (empty($res->uid)) 
			{
				$this->setMsg(2014);
			}
		}
		
        if (!verify_api::sendMobileCode($mobile)) {
            $this->setMsg(201);
        }

        $this->setMsg(0);
    }

    public function pageRegister()
    {
        $this->v(
            [
                'mobile'       => 1013,
                'verifyCode'   => 1014,
                'password'     => 1015,
                'repeatPasswd' => 1016,
            ]
        );

        if (!utility_valid::mobile($this->paramsInfo['params']['mobile'])) {
            $this->setMsg(1012);
        }

        if (!preg_match('/^[\\x20-\\x7e]+$/', $this->paramsInfo['params']['password'])) {
            $this->setMsg(1017);
        }

        if (strlen($this->paramsInfo['params']['password']) < 6 || strlen($this->paramsInfo['params']['password']) > 20) {
            $this->setMsg(1018);
        }

        if ($this->paramsInfo['params']['password'] != $this->paramsInfo['params']['repeatPasswd']) {
            $this->setMsg(1019);
        }

        if (!verify_api::verifyMobile($this->paramsInfo['params']['mobile'], $this->paramsInfo['params']['verifyCode'])) {
            $this->setMsg(2011);
        }

        $name = $this->paramsInfo['params']['mobile']; // 暂时用mobile替代用户名

        // register
        if ($this->paramsInfo['params']['type'] == 1) {
            if (user_api::isRegister($this->paramsInfo['params']['mobile'])) {
                $this->setMsg(2009);
            }

            $uid = user_api::registerByMobile($name, $this->paramsInfo['params']['mobile'], $this->paramsInfo['params']['password']);

            if ($uid) {
                $msg   = "#name#={$this->paramsInfo['params']['mobile']}&#company#=高能壹佰";
                $tplId = 630841;
                if (verify_api::sendSMS($this->paramsInfo['params']['mobile'], $msg, $tplId)) {
                    $this->setData(
                        [
                            'uid' => $uid
                        ]
                    );
                }
                SLog::write('注册成功发送短信失败['.var_export($this->paramsInfo).']');
                $this->setMsg(2015);
            } else {
                $this->setMsg(2012);
            }
        }

        // update password
        if ($this->paramsInfo['params']['type'] == 2) {
            $res = user_api::getUserIdByMobile($this->paramsInfo['params']['mobile']);
            if (empty($res->uid)) {
                $this->setMsg(2014);
            }

            if (user_api::updatePassword($res->uid, $this->paramsInfo['params']['password'])) {
                $this->setMsg(0);
            }

            $this->setMsg(2013);
        }

        $this->setMsg(3000);
    }

	/*
	 * 注册和找回密码
	 * @author zhengtianlong
	 * @params $mobile $verifyCode $password $type $name
	 */
	 public function pageRegisterV2()
    {
		
		//必传参数
        $this->v(
            [
                'mobile'     => 1013,
                'verifyCode' => 1014,
                'password'   => 1015,
            ]
        );

		$type = !empty($this->paramsInfo['params']['type'])?$this->paramsInfo['params']['type']:1;

        if (!utility_valid::mobile($this->paramsInfo['params']['mobile']))
		{
            $this->setMsg(1012);
        }

        if (!preg_match('/^[\\x20-\\x7e]+$/', $this->paramsInfo['params']['password']))
		{
            $this->setMsg(1017);
        }

        if (strlen($this->paramsInfo['params']['password']) < 6 || strlen($this->paramsInfo['params']['password']) > 20)
		{
            $this->setMsg(1018);
        }

        if (!verify_api::verifyMobile($this->paramsInfo['params']['mobile'], $this->paramsInfo['params']['verifyCode']))
		{
            $this->setMsg(2011);
        }
		
        // register
        if ($type == 1)
		{
			$this->v(['name' => 1023]);
			//不能是数字和特殊字符
			if(!preg_match('/^[a-zA-Z_\x{4e00}-\x{9fa5}]+$/u',$this->paramsInfo['params']['name']))
			{
				$this->setMsg(2040);
			}
			//真实姓名最少2个汉字最多5个汉字
			if(preg_match("/[\x7f-\xff]/", $this->paramsInfo['params']['name']))
			{
				if(!utility_tool::check_string($this->paramsInfo['params']['name'], 5,2))
				{
					$this->setMsg(2039);
				}
			}
			//真实姓名不能超过25个英文字符
			if(preg_match("/[a-zA-Z\s]+$/", str_replace(' ','',$this->paramsInfo['params']['name'])))
			{
				if(!utility_tool::check_string($this->paramsInfo['params']['name'], 25,1))
				{
					$this->setMsg(2038);
				}
			}

            if (user_api::isRegister($this->paramsInfo['params']['mobile']))
			{
                $this->setMsg(2009);
            }

            $uid = user_api::registerByMobile($this->paramsInfo['params']['name'], $this->paramsInfo['params']['mobile'], $this->paramsInfo['params']['password']);

            if ($uid) {
                $msg   = "#name#={$this->paramsInfo['params']['mobile']}&#company#=高能壹佰";
                $tplId = 630841;
                if (verify_api::sendSMS($this->paramsInfo['params']['mobile'], $msg, $tplId))
				{
                    $this->setData(['uid' => $uid]);
                }
                SLog::write('注册成功发送短信失败['.var_export($this->paramsInfo).']');
                $this->setMsg(2015);
            } else {
                $this->setMsg(2012);
            }
        }

        // update password
        if ($type == 2)
		{
            $res = user_api::getUserIdByMobile($this->paramsInfo['params']['mobile']);
            if (empty($res->uid)) {
                $this->setMsg(2014);
            }

            if (user_api::updatePassword($res->uid, $this->paramsInfo['params']['password'])) {
                $this->setMsg(0);
            }

            $this->setMsg(2013);
        }

        $this->setMsg(3000);
    }


	/*
	 * 检查验证码
	 * @author zhengtianlong
	 */
	 public function pageCheckVerify()
	 {
		$this->v(
			[
				'mobile'     => 1013,
				'verifyCode' => 1014
			]
        );
		
		$mobile     = $this->paramsInfo['params']['mobile'];
		$verifyCode = $this->paramsInfo['params']['verifyCode'];

		if (!verify_api::verifyMobile($mobile, $verifyCode))
		{
            $this->setMsg(2011);
        }
		$this->setMsg(0);

	 }

	 /*
	  * 修改密码
	  * @author zhengtianlong
	  */
	  public function pageUpdatePwd()
	  {
		$this->v(
			[
				'mobile'   => 1013,
				'uid'      => 1001,
				'password' => 1015,
				'oldPassword'=> 1015
			]
        );
		$mobile   = $this->paramsInfo['params']['mobile'];
		$uid      = $this->paramsInfo['params']['uid'];
		$password = $this->paramsInfo['params']['password'];
		
        $md5Password = user_api::checkPassword($this->paramsInfo['params']['oldPassword']);
		
		$oldPassword = $md5Password->result->str;
		
		$res = user_api::getUserIdByMobile($mobile);

        if (empty($res->uid))
		{
			$this->setMsg(2014);
		}

        if($res->uid == $uid)
        {
			$userBase = user_api::getBasicUserAndMobile($res->uid);
			if($userBase->password == $oldPassword)
			{
				if (user_api::updatePassword($res->uid, $password))
				{
					$this->setMsg(0);
				}
			}
        }

		$this->setMsg(2013);
	  }



    public function pageOrder()
    {
        $this->v(
            [
                'uid'    => 1000,
                'status' => 1000,
            ]
        );

        $condition = [
            //'price'   => 'price>0',
            'user_id' => $this->paramsInfo['params']['uid']
        ];

        if ($this->paramsInfo['params']['status'] == 'all') {
            $condition['status'] = [2,0,-2,-4];
        }

        if ($this->paramsInfo['params']['status'] == 'paid') {
            $condition['status'] = 2;
        }

        if ($this->paramsInfo['params']['status'] == 'unpaid') {
            $condition['status'] = 0;
        }

        if ($this->paramsInfo['params']['status'] == 'cancel') {
            $condition['status'] = [-2,-4];
        }

        if ($this->s('cid')) {
            $condition['course_id'] = $this->paramsInfo['params']['cid'];
        }

        if ($this->s('orderId')) {
            $condition['order_id'] = $this->paramsInfo['params']['orderId'];
        }

        $page   = $this->s('page') ? (int)$this->paramsInfo['params']['page'] : 1;
        $length = $this->s('length') ? (int)$this->paramsInfo['params']['length'] : 20;

        $ret = course_api::listFeeOrder($condition, $page, $length);

        empty($ret->data) && $this->setMsg(3002);

        $result['total']     = $ret->size;
        $result['totalPage'] = $ret->total;
        $result['page']      = $page;
        $result['data'] = $classList = $planList = $classIdArr = [];

        foreach ($ret->data as $v) {
            $classIdArr[] = $v->ext;
        }

        $classInfo = course_api::getClassByClassIdArr($classIdArr);
        $planInfo = course_api::getClassPlan($classIdArr);

        if (!empty($planInfo)) {
            $tmpClass = [];
            foreach ($planInfo as $plan) {
                if (!in_array($plan->fk_class, $tmpClass)) {
                    $tmpClass[] = $plan->fk_class;
                    $planList[$plan->fk_class] = $plan->start_time;
                }
            }
        }

        if (!empty($classInfo->data)) {
            foreach ($classInfo->data as $v) {
                $v->start_time = !empty($planList[$v->pk_class]) ? $planList[$v->pk_class] : '';
                $classList[$v->pk_class] = $v;
            }
        }

        foreach ($ret->data as $m) {
            $m->class = !empty($classList[$m->ext]) ? $classList[$m->ext] : '';

            $result['data'][] = [
                'courseType'  => '线上课',
                'courseId'    => $m->course_id,
                'courseTitle' => $m->course->course_name,
                'className'   => $m->class->name,
                'imgUrl'      => $this->imgUrl($m->course->thumb_med),
                'teacherName' => $m->class->teacher_name,
                'startTime'   => date('n月j日H:i', strtotime($m->class->start_time)),
                'orderId'     => $m->order_id,
                'orderStatus' => $m->status,
                'price'       => $m->price/100
            ];
        }

        $this->setData($result);
    }


    public function pageBasicInfo()
    {
         $res = user_api::getBasicUserAndMobile($this->paramsInfo['params']['uid']);

         !empty($res) && $this->setData($res);

         $this->setMsg(3002);
    }

    public function pageUserBasicInfo()
    {
        //$this->v(['uid' => 1000]);
        $res = user_api::getBasicUser($this->paramsInfo['params']['uid']);
        empty($res) && $this->setMsg(3002);

        $data = [
            'userId'     => $res->pk_user,
            'name'       => $res->name,
            'realName'   => $res->real_name,
            'mobile'     => $res->mobile,
            'thumbMed'   => interface_func::imgUrl($res->thumb_med),
            'thumbBig'   => interface_func::imgUrl($res->thumb_big),
            'thumbSmall' => interface_func::imgUrl($res->thumb_small),
        ];

        $this->setData($data);
    }

    public function pageInfo()
    {
         $res = user_api::getBasicUser($this->paramsInfo['params']['userId']);
         empty($res) && $this->setMsg(3002);

         $data = [
             'userToId' => $this->paramsInfo['params']['userId'],
             'userToName' => !empty($res->name) ? $res->name : SLanguage::tr('未设置', 'message'),
             'userImage' => $this->imgUrl($res->thumb_small)
         ];

        $this->setData($data);
    }

    public function pageOrderDetail()
    {
        $this->v(['orderId'=>1000]);

        if (!utility_tool::check_int($this->paramsInfo['params']['orderId']))
            $this->setMsg(1022);

        $data = interface_user_api::getOrderInfo($this->paramsInfo['params']['orderId']);
        if (!empty($data)) {
            $this->setData($data);
        }

        $this->setData([]);
    }

	/*
	 * 个人信息
	 * @author zhengtianlong
	 * @params $uid
	 */
	public function pageGetInfo()
	{
        $gradeArr = [
            '1001' => '一年级',
            '1002' => '二年级',
            '1003' => '三年级',
            '1004' => '四年级',
            '1005' => '五年级',
            '1006' => '六年级',
            '2001' => '初一',
            '2002' => '初二',
            '2003' => '初三',
            '3001' => '高一',
            '3002' => '高二',
            '3003' => '高三'
        ];
		$uid = !utility_tool::check_int($this->paramsInfo['params']['uid']) ? $this->setMsg(1022) : $this->paramsInfo['params']['uid'];
		$res = user_api::getUser($uid);
        empty($res) && $this->setMsg(3002);
		$sexArr    = ['male'=>'男','female'=>'女'];

		$level0 = !empty($res->student->region_level0) ? $res->student->region_level0 : 0;
		$level1 = !empty($res->student->region_level1) ? $res->student->region_level1 : 0;
		$level2 = !empty($res->student->region_level2) ? $res->student->region_level2 : 0;
		if($level2 == 0)
		{
			$addId = $level1;
		}else
		{
			$addId = $level2;
		}

		//学校数据
		$schoolArr = array();
		$school    = array();
		$schoolArr = region_api::ListSchool($addId,$res->student->school_type);
		if(!empty($schoolArr))
		{
			foreach($schoolArr as $v)
			{
				$school[$v->school_id] = $v->school_name;
			}
		}

		//地区数据
		$address = '';
		if(!empty(region_geo::$region[$level0]))
		{
			$address.= region_geo::$region[$level0];
		}
		if(!empty(region_geo::$region[$level1]))
		{
			$address.= ','.region_geo::$region[$level1];
		}
		if(!empty(region_geo::$region[$level2]))
		{
			$address.= ','.region_geo::$region[$level2];
		}
		$data = [
			"nickName" => $res->name,
			"image"    => 'http:'.$res->avatar->large,
			"mobile"   => $res->mobile,
			"realName" => $res->profile->real_name,
			"sex"      => !empty($res->gender) ? $sexArr[$res->gender] : '',
			"address"  => $address,
			"addressId"=> $level0.",".$level1.",".$level2,
            "schoolType"=>$res->student->school_type,
			"school"   => !empty($school) ? (!empty($school[$res->student->school_id])?$school[$res->student->school_id]:'') : '',
			"schoolId" => !empty($res->student->school_id)?$res->student->school_id:0,
            "grade"    => !empty($res->student->grade) ? (!empty($gradeArr[$res->student->grade])?$gradeArr[$res->student->grade]:'') : '',
			"gradeId"  => !empty($res->student->grade) ? $res->student->grade : 0,
            "birthday" => $res->birthday
		];

		$this->setData($data);
	}

	/*
	 * 修改个人信息
	 * @author zhengtianlong
	 * @params
	 */
	 public function pageSetUserInfo()
	 {
       $uid    = !empty($this->paramsInfo['params']['uid'])?$this->paramsInfo['params']['uid']:$this->setMsg(1);
		if(isset($this->paramsInfo['params']['sex']))
		{
			$baseParams['gender'] = self::$gender[$this->paramsInfo['params']['sex']];
		}

        if(isset($this->paramsInfo['params']['schoolType']))
        {
            $fileParams['school_type'] = $this->paramsInfo['params']['schoolType'];
        }

        if(!empty($this->paramsInfo['params']['nickName']))
        {
		    //昵称不能超过15个字符
		    if(!empty($this->paramsInfo['params']['nickName']) && !utility_tool::check_string($this->paramsInfo['params']['nickName'],15,1))
		    {
			    $this->setMsg(2036);
		    }
		    $baseParams['nickName'] = $this->paramsInfo['params']['nickName'];
        }
		if(!empty($this->paramsInfo['params']['realName']))
		{
			//不能是数字和特殊字符
			if(!preg_match('/^[a-zA-Z_\x{4e00}-\x{9fa5}]+$/u',$this->paramsInfo['params']['realName']))
			{
				$this->setMsg(2040);
			}
			//真实姓名不能超过5个汉字
			if(preg_match("/[\x7f-\xff]/", $this->paramsInfo['params']['realName']))
			{
				if(!utility_tool::check_string($this->paramsInfo['params']['realName'], 5,2))
				{
					$this->setMsg(2037);
				}
			}
			//真实姓名不能超过25个英文字符
			if(preg_match("/[a-zA-Z\s]+$/", str_replace(' ','',$this->paramsInfo['params']['realName'])))
			{
				if(!utility_tool::check_string($this->paramsInfo['params']['realName'], 25,1))
				{
					$this->setMsg(2038);
				}
			}
			$fileParams['student_name'] = $this->paramsInfo['params']['realName'];
			$baseParams['realName'] = $this->paramsInfo['params']['realName'];
		}

		if(!empty($this->paramsInfo['params']['birthday']))
		{
			$baseParams['birthday'] = $this->paramsInfo['params']['birthday'];
		}

		if(!empty($this->paramsInfo['params']['school']))
		{
			$fileParams['school_id'] = $this->paramsInfo['params']['school'];
		}

		if(!empty($this->paramsInfo['params']['grade']))
		{
			$fileParams['grade'] = $this->paramsInfo['params']['grade'];
		}

		if(!empty($this->paramsInfo['params']['address']))
		{
			$address = explode(',',$this->paramsInfo['params']['address']);
			$fileParams['region_level0'] = !empty($address['0'])?$address['0']:0;
			$fileParams['region_level1'] = !empty($address['1'])?$address['1']:0;
			$fileParams['region_level2'] = !empty($address['2'])?$address['2']:0;
		}
		
        if(!empty($baseParams))
        {
   		    $baseRet = user_api::updateBase2($uid,$baseParams);
			if($baseRet)
			{
				$this->setMsg(0);
			}
        }

	    if(!empty($fileParams))
        {
		   $profileRet = user_api::setStudentProfile2($uid,$fileParams);
		   
		   if($profileRet)
		   {
			  $this->setMsg(0);
		   }
	    }

		$this->setMsg(3002);

	 }

	 /*
	  * 修改头像
	  * @author zhengtianlong
	  * @params $uid
	  */
	  public function pageUploadPic()
	  {
		  $uid = !empty($this->paramsInfo['params']['uid'])?$this->paramsInfo['params']['uid']:$this->setMsg(1);
		  $img = !empty($this->paramsInfo['params']['image'])?$this->paramsInfo['params']['image']:$this->setMsg(1);
		  $data = array();
		  $path = ROOT_WWW."/upload/tmp";
		  if(!is_dir($path))
		  {
			mkdir($path,0777,true);
		  }
		  $filename = $path."/".$uid.".org.jpg";
		  
		  if(file_put_contents($filename, base64_decode($img)))
		  {
			ini_set('gd.jpeg_ignore_warning', 1);;
			list($width, $height, $type, $attr) = getimagesize($filename);
			if(!$width || !$height)
			{
				$this->setMsg(3002);
			}  
			switch($type)
			{
				case 1: $img_r = imagecreatefromgif($filename);break;
				case 2: $img_r = imagecreatefromjpeg($filename);break;
				case 3: $img_r = imagecreatefrompng($filename);break;
				default:
					$this->setMsg(3002);
			}	
			  
			$thumbs = user_thumb::genByFile($filename);
			/*
			  [large] => 4,1a20b130fa47
				[medium] => 4,1a218fcb2551
				[small] => 5,1a22c926a8e0
			*/
			if($thumbs)
			{
				$ret_up = user_api::updateThumbs($uid,$thumbs);
				$data = new stdclass;
				$data->thumb_big = $thumbs['large'];
                $data->thumb_med = $thumbs['medium'];
                $data->thumb_small = $thumbs['small'];
                $data->fk_user   = $uid;
                $data->create_time = date('Y-m-d H:i:s', time());			
				user_api::addUserThumb($data);
				user_api::loginByUid($uid);
				
			}
		  }	
		  $data = [
			'url'=>!empty($thumbs['medium'])?$this->imgUrl($thumbs['medium']):''
		  ];
		  $this->setData($data);
	  }

	  /*
	   * 学校查询
	   * @author zhengtianlong
	   * @params $addressId
	   */
	   public function pageGetScholl()
	   {
		   $addressStr = !empty($this->paramsInfo['params']['addressId'])?$this->paramsInfo['params']['addressId']:$this->setMsg(3002);
		   $addressArr = explode(',',$addressStr);
           if(end($addressArr)==0)
           {
                $addressId = $addressArr[1];
           }else
           {
                $addressId = end($addressArr);
           }
           $result = region_api::ListSchool($addressId,'');
		   empty($result) && $this->setMsg(3002);
		   foreach($result as $val)
		   {
               if($val->school_type == 1)
               {
                   $data['data']['primary'][] = [
                       'schoolId' => $val->school_id,
                       'name'     => $val->school_name
                   ];
               }
               if($val->school_type == 6)
               {
			        $data['data']['middle'][] = [
					    'schoolId' => $val->school_id,
				    	'name'     => $val->school_name
			        ];
               }
		   }
		   $this->setData($data);
	   }

	   /*
	    * 地区接口
		* @author zhengtianlong
		*/
	   public function pageGetArea()
	   {
		   $data = region_area::$area;
		   $this->setData($data);
	   }

	   /*
		* 年级查询
		* @author zhengtianlong
		* @params $gradeList
		*/
		public function pageGetGrade()
		{
			$data = course_grade::$data;
			$this->setData($data);
		}

    /*
     * 取消订单
     * @author zhengtianlong
	 * @params $orderId
     */
    public function pageOrderStatus()
    {
        if(!utility_tool::check_int($this->paramsInfo['params']['orderId']))
        {
             $this->setMsg(1022);
        }
        $params = [
            'order_id'     => $this->paramsInfo['params']['orderId'],
            'status' => 'cancel'
        ];

		$orderInfo = course_api::getFeeOrder($this->paramsInfo['params']['orderId']);
		if($orderInfo->status=='initial')
		{
			$res = course_api::setFeeOrderStatus($params);
			if($res)
			{
				$this->setMsg(0);
			}
		}
        $data = [
			'code'    => -1,
			'message' => 'error',
			"errMsg"  => "操作失败"
		];
        exit(json_encode($data));
    }
    /*
     * 删除订单
     * @author zhengtianlong
	 * @params $orderId
     */
    public function pageDelOrder()
    {
         if(!utility_tool::check_int($this->paramsInfo['params']['orderId']))
        {
             $this->setMsg(1022);
        }
        $params = [
            'order_id'     => $this->paramsInfo['params']['orderId'],
            'status' => 'deleted'
        ];

        $res = course_api::setFeeOrderStatus($params);
        if($res)
        {
            $data = [
                'code'    => 0,
                'message' => 'success'
            ];
        }else
        {
           $data = [
            'code'    => -1,
            'message' => 'error'
           ];
        }
        $this->setData($data);

    }


    public function pageAddReg()
    {
        $this->v(
            [
                'userId'    => 1000,
                'courseId' => 1000,
                'classId' => 1000,
            ]
        );

        $courseId = intval($this->paramsInfo['params']['courseId']);
        $classId  = intval($this->paramsInfo['params']['classId']);
        $userId = intval($this->paramsInfo['params']['userId']);

        $classData = course_api::getclass($classId);
        empty($classData) && $this->setMsg(3002);

        if(!empty($classData->user_total) && !empty($classData->max_user)){
            ($classData->user_total >= $classData->max_user) && $this->setMsg(2034);
        }

        $courseInfo = course_api::getCourseone($courseId);
        empty($courseInfo) && interface_func::setMsg(3002);

        if ($courseInfo->fee_type == 1) {
            interface_func::setMsg(3002);
        }

        $data = array(
            "class_id"   => $classId,
            "course_id"  => $courseId,
            "uid"        => $userId,
            "user_owner" => $courseInfo->user_id,
            "status"     => 1,
        );

        course_api::addregistration($data) ? interface_func::setMsg(0) : interface_func::setMsg(1);
    }

    // 生成订单
    public function pageAddOrder()
    {
        $this->v(
            [
                'uid'    => 1000,
                'courseId' => 1000,
                'classId' => 1000,
            ]
        );

        $courseId = intval($this->paramsInfo['params']['courseId']);
        $classId  = intval($this->paramsInfo['params']['classId']);
        $userId = intval($this->paramsInfo['params']['uid']);

        $courseInfo = course_api::getCourseone($courseId);
        empty($courseInfo) && interface_func::setMsg(3002);
        // 免费课不能生成订单
        if ($courseInfo->fee_type == 0) {
            interface_func::setMsg(2035);
        }

        //生成订单
        $res = course_api::addFeeOrder(
            $userId,
            $courseInfo->user_id,
            $courseId,
            $courseInfo->fee->price,
            $courseInfo->fee->price_market,
            $classId
        );

        if (!empty($res->order_id)) {
            $orderInfo = interface_user_api::getOrderInfo($res->order_id);
            if (!empty($orderInfo)) {
                $this->setData($orderInfo);
            }
            // 刚生成的订单 获取不到信息
            $this->setMsg(3000);
        }

        $this->setMsg(1);
    }

    public function pageProtocol()
    {
        $data = '云课直播平台服务协议
一、服务项目
云课直播平台是北京高能壹佰教育科技有限公司利用服务器及相关软件为用户提供网络教育及收费所需要的相应功能，同时提供相关技术及网络支持服务。
云课直播平台服务的具体内容和收费形式以云课直播平台网站及产品中所具有的功能和收费为准。

二、协议的确认与接受
用户必须完全同意《云课直播平台服务协议》全部条款，方可注册开通云课直播平台服务。用户使用云课直播平台网络服务的行为将视为用户自动签定本协议，并接受本协议全部内容和条款。

三、费用结算方式
用户使用云课直播平台服务在平台上开展收费项目所得金额，按照用户与云课直播平台实际合同约定分成，由云课直播平台定期进行结算，并支付给用户。
云课直播平台会不定期向用户赠送服务项目。用户充分理解所有的赠送服务项目均为云课直播平台在正常服务之外的一次性特别优惠，如本协议解除，会自动扣除相应金额。对于赠送的服务项目，云课直播平台拥有最终的解释权。

四、知识产权
用户利用云课直播平台服务产生的任何作品，包括但不限于图片、音乐、视频的知识产权均归用户和高能壹佰共同所有，高能壹佰有权使用上述作品。
除法律法规另有规定外，未获得权利人的事先授权，用户不得随意使用第三方作品。如果云课直播平台收到任何第三方作品所有人或其合法代表发出的合理通知后，有权移除相应侵权作品。
五、云课直播平台的保证
云课直播平台根据所适用的法律，已经取得签订并履行本协议的相关资质。
云课直播平台签订并履行本协议不会侵犯任何人的知识产权或其他合法权利。如果针对本协议的签订或者履行出现任何第三人指控侵权之情形， 云课直播平台将采取一切必要的措施进行抗辩。
六、用户的保证
用户根据所适用的法律，已经取得签订并履行本协议的相关资质。
用户签订并履行本协议不会侵犯任何人的知识产权或其他合法权利。如果针对本协议的签订或者履行出现任何第三人指控侵权之情形， 用户将采取一切必要的措施进行抗辩。
用户保证在使用云课直播平台网络服务过程中提供的信息不含有任何违反国家有关法律、法规及中华人民共和国承认或加入的国际条约的内容， 包括但不限于危害国家安全、淫秽色情、虚假、侮辱、诽谤、恐吓或骚扰、侵犯他人知识产权、人身权或其他合法权益以及有违 社会公序良俗的内容或指向这些内容的链接。
因用户违反本协议，而导致云课直播平台受到第三方投诉或诉讼，或面临相关主管机关的审查或质询，云课直播平台有权先暂停对用户提供的服务。用户应在收到云课直播平台通知后，应以自己名义出面与第三方协商、应诉或接受相关主管机关审查或质询，并承担所有费用（包括但不限于 诉讼费、律师费、赔偿款），并赔偿因此给云课直播平台造成的全部损失。
如用户违反上述任何条款，云课直播平台有权终止向用户提供服务，并解除本协议，同时保留有进一步追究用户法律责任的权利。
七、保密
在本协议订立前、履行中及终止或解除后，未经协议其他方书面同意，任何一方对本协议履行过程中所知悉的资料、信息、数据负有保密责任。未经一方书面同意，任何一方不得超越本协议履行之目的自行使用，或授权任何其他第三方使用，或向其他第三方泄露。
如对方提出要求，任何一方均应将载有对方保密信息之原件、副本、重制本及节录本按对方要求归还，或予以删除、销毁，并且不得继续使用这些保密信息。
本保密条款具有独立性，不受本协议的终止或解除的影响。
八、协议变更
一方变更通知、通讯地址或者其他联系方式，应自变更之日起3个工作日内，将变更后的地址、联系方式通知另一方，否则变更方应对此造成的一切后果承担责任。
云课直播平台有权随时根据中华人民共和国有关法律、法规的变化、互联网的发展以及公司经营状况和经营策略的调整等情况修改本协议，但不得单方不公平地加大用户的义务。协议条款一旦发生变动，云课直播平台将会在其官方网页上提示有关内容。用户如果不同意所改动的内容，可以在7个工作日内停止接受服务并同时书面通知云课直播平台，对本协议进行解除；如果用户继续接受服务，则视为接受本协议条款的修改。
在本协议有效期内，一方出现上市、被收购、分立、与第三方合并、名称变更等事由，另一方同意出现上述事由的一方可以将其在本协议中的权利和义务转让给相应的权利或义务承受者，但转让方应保证另一方在本协议中的权益不会因此而受到不利影响，否则转让方应承担由此引起的一切法律责任和经济损失。
九、协议解除
如任何一方严重违反本协议，则另一方有权解除本协议。

十、不可抗力
“不可抗力”是指甲乙双方不能合理控制、不可预见或即使预见亦无法避免的事件，该事件妨碍、影响或延误任何一方根据协议履行其全部或部分义务。该事件包括但不限于政府行为、自然灾害、战争、黑客攻击、计算机病毒（如木马程序、蠕虫等）、电信部门技术性调整或任何其它类似事件。
出现不可抗力事件时，受影响方应及时、充分地以邮件或电话方式通知对方，并告知对方该类事件对本协议可能产生的影响，并应当在合理期限（不可抗力事件发生后30日）内提供该等事件的详细信息及由有关组织出具的解释受影响方因此无法履行全部或部分本协议项下义务的相关证明。
由于以上所述不可抗力事件致使协议的部分或全部不能履行或延迟履行，则甲乙双方于彼此间不承担任何违约责任。
十一、争议解决
由本协议产生的一切争议由双方友好协商解决。协商不成的，双方一致同意将争议提交北京仲裁委员会，按其在提起仲裁时现行有效的仲裁规则进行仲裁。仲裁裁决是终局的，协议双方都应执行。仲裁费用由败诉方承担。
本协议 的订立、效力、解释、履行和争议的解决均应适用中华人民共和国法律。
十二、其他
云课直播平台在相关网页上及产品提供的服务说明、价格说明、表格等均为本协议不可分割的一部分，与本协议具有同等法律效力。
任何一方没有行使其权利或者没有就对方的违约行为采取任何行动，不应被视为是对权利的放弃或者对追究违约责任或者义务的放弃。任何一方放弃针对对方的任何权利，或者放弃追究对方的任何过失，不应视为对任何其他权利或者追究任何其他过失的放弃。
无论因何种原因（包括但不限于违反适用的法律法规）导致本协议任何条款完全或部分无效或不具有执行力，不影响本协议任何其他条款的效力、合法和可执行性。
任何一方致另一方的通知，均可通过网站通告、站内邮件或电子邮件发送。
';
		$this->setData($data);
    }

	
	/*
	 * 学生所报课程与班级
	 * @params $uid 老师id  $stuId 学生id 
	 * @author zhengtianlong
	 */
	public function pageGetStudentCourse()
	{
		$this->v(['uid'=>1000,'stuId'=>1000]);
		$page  = !empty($this->paramsInfo['params']['page'])?$this->paramsInfo['params']['page']:1;
		$length= !empty($this->paramsInfo['params']['length'])?$this->paramsInfo['params']['length']:10;
		$uid   = $this->paramsInfo['params']['uid'];
        $this->uidTokenValid($this->paramsInfo['token'], $uid);
		$stuId = $this->paramsInfo['params']['stuId'];
		

		//老师下所有的课
		$planParams = [
			'q' => ['teacher_id'=>$uid,'status'=>'1,2,3'],
			'f' => ['course_id','class_id','class_name'],
			'pl'=> 1000
		];

		$res_plan = seek_api::seekPlan($planParams);
		empty($res_plan->data) && $this->setMsg(3002);
		$teacherCidArr = array_reduce($res_plan->data, create_function('$v,$w', '$v[$w->course_id]=$w->course_id;return $v;'));
		
		//学生报所有课程
		$res_student = course_api::getstudentCourse($stuId);
	
		empty($res_student->data) && $this->setMsg(3002);
		$studentCidArr = array_reduce($res_student->data, create_function('$v,$w', '$v[$w->fk_course]=$w->fk_course;return $v;'));
        $studentClassArr = array_reduce($res_student->data, create_function('$v,$w', '$v[$w->fk_class]=$w->fk_class;return $v;'));	    

		//该学生所报该老师的课程id
		$intersectArr = array_intersect_assoc($teacherCidArr,$studentCidArr);

    	empty($intersectArr) && $this->setMsg(3002);
		$intersectStr = implode(',',$intersectArr);
        $studentClassStr = implode(',',$studentClassArr);
	
       	//课程信息
		$courseParams = [
			'q' => ['course_id'=>$intersectStr,'status'=>'1,2,3'],
			'f' => ['thumb_med','course_id'],
			'pl'=> 1000
 		];
		
		$res_course = seek_api::seekCourse($courseParams);
		empty($res_course->data) && $this->setMsg(3002);
	

        $course = array();	
        foreach($res_course->data as $v)
        {
            $course[$v->course_id] = [
                'img'    => $this->imgUrl($v->thumb_med)
            ];
        }

        $params = [
            'q'  => ['course_id'=>$intersectStr,'status'=>'1,2,3','class_id'=> $studentClassStr] ,
            'f'  => ['course_id','class_id','class_name','status','course_name'],
            'pl' => 1000
        ];
        $result = seek_api::seekPlan($params);

	   	empty($result->data) && $this->setMsg(3002);
        $courseType = 0;        
        foreach($result->data as $v)
        {
            $list[$v->class_id] = [
                'courseId'   => $v->course_id,
                'courseName' => $v->course_name,
                'courseType' => $courseType,
                'status'     => $v->status,
                'classId'    => $v->class_id,
                'className'  => $v->class_name,
                'image'      => !empty($course[$v->course_id]['img'])?$course[$v->course_id]['img']:''
            ];
           	if($courseType > 0)
			{
				$list[$v->course_id]['address'] = '';
				$list[$v->course_id]['time']    = '';
			}
        }


        $data['total']     = count($list);
        $data['totalPage'] = ceil($data['total']/$length); 
        $data['page']      = $page;

        $data['data'] = array_values($list);
        $offset       = ($page-1)*$length;
        $data['data'] = array_slice($data['data'],$offset,$length);
		
        
        empty($data['data']) && $this->setMsg(3002);


		$this->setData($data);
	}
	
	/*
	 * 意见反馈
	 * @params  $type状态  $content 内容  $mobile 手机号
	 * @author zhengtianlong
	 */
	public function pageFeedBack()
	{
		$this->v(['type'=>1000,'content'=>1000,'mobile'=>1013]);
		$type    = $this->paramsInfo['params']['type'];
		$content = htmlspecialchars($this->paramsInfo['params']['content']);
		$mobile  = $this->paramsInfo['params']['mobile'];
		$uid     = isset($this->paramsInfo['params']['uid'])?$this->paramsInfo['params']['uid']:0;
		
		$regex = '/^1[3|4|5|7|8][0-9]{9}$/';
		if (!empty(trim($mobile)) && !preg_match($regex, $mobile)) 
		{
			$this->setMsg(1012);
		}
		$data = [
			'fk_user'     => $uid,
			'ques_type'   => $type,
			'content'     => $content,
			'mobile'      => $mobile,
			'create_time' => date('Y-m-d H:i:s', time())
		];

		$res = user_api::addUserFeedback($data);
		
		if($res->result->code==0)
		{
			$this->setMsg(0);
		}
		$this->setMsg(3002);
	}

    public function pagePartner()
    {
        $this->v(
            [
                'type' => 1000,
                'openId' => 1000
            ]
        );

        if (!in_array($this->paramsInfo['params']['type'], [1,2])) {
            interface_func::setMsg(1026);
        }

        $partnerInfo = user_api::getParterner(
            $this->paramsInfo['params']['type'],
            $this->paramsInfo['params']['openId']
        );

        if (empty($partnerInfo->parterner_id)) {
            $res = user_api::setParterner(
                0,
                $this->paramsInfo['params']['nickName'],
                $this->paramsInfo['params']['type'],
                $this->paramsInfo['params']['openId'],
                json_encode($this->paramsInfo['params']['info']),
                $this->paramsInfo['params']['authCode'],
                $this->paramsInfo['params']['thumbUrl']
            );

            empty($res->parterner_id) && interface_func::setMsg(3000);
        }

        (empty($partnerInfo->uid)) && interface_func::setMsg(1037);
        // 检测是否设置真实姓名(只检测t_user表)
        $userInfo = user_api::getBasicUser($partnerInfo->uid);
        empty($userInfo) && interface_func::setMsg(3002);
        //empty($userInfo->real_name) && interface_func::setMsg(2042);

        if (user_api::loginByUid($partnerInfo->uid)) {
            $data = utility_session::get()['user'];
            $data['mobile'] = $userInfo->mobile;
            $data['realName'] = !empty($userInfo->real_name) ? $userInfo->real_name : SLanguage::tr('未设置', 'message');
            interface_func::setData($data);
        }

        interface_func::setMsg(1);
    }

    public function pageCheckIsBind()
    {
        $this->v(
            [
                'mobile' => 1000,
                'code'   => 1000,
                'openId' => 1000,
                'type'   => 1000
            ]
        );

        if (!verify_api::verifyMobile($this->paramsInfo['params']['mobile'], $this->paramsInfo['params']['code'])) {
            $this->setMsg(2011);
        }
        
        $partnerInfo= user_api::getParterner(
            $this->paramsInfo['params']['type'],
            $this->paramsInfo['params']['openId']
        );
        empty($partnerInfo) && interface_func::setMsg(1031);

        $userInfo = utility_services::call("/user/info/GetUserInfoByMobile/{$this->paramsInfo['params']['mobile']}");

        if ($userInfo->code || empty($userInfo->result->real_name))
            interface_func::setMsg(2042);

        $res = user_api::bindParterner($partnerInfo->parterner_id, $userInfo->result->pk_user);
        empty($res) && interface_func::setMsg(1032);

        user_api::loginByUid($userInfo->result->pk_user) && interface_func::setData(utility_session::get()['user']);

        interface_func::setMsg(1);
    }

    public function pageUpdateUserRealName()
    {
        $this->v(
            [
                'mobile'   => 1000,
                'userName' => 1000,
                'openId'   => 1000,
                'type'     => 1000
            ]
        );

        if (!in_array($this->paramsInfo['params']['type'], [1,2])) {
            interface_func::setMsg(1026);
        }

        // 检测是否注册
        $uid = user_api::isRegister($this->paramsInfo['params']['mobile']);
        if (empty($uid)) {
            $partnerInfo= user_api::getParterner(
                $this->paramsInfo['params']['type'],
                $this->paramsInfo['params']['openId']
            );
            empty($partnerInfo) && interface_func::setMsg(1031);

            // 用真实姓名注册
            $uid = user_api::registerByMobile(
                $this->paramsInfo['params']['userName'],
                $this->paramsInfo['params']['mobile']
            );
            empty($uid) && interface_func::setMsg(2012);

            // update user source
            $source = 0;
            if ($this->paramsInfo['u'] == 'a') {
                $source = 1001; //android
            }

            if ($this->paramsInfo['u'] == 'i') {
                $source = 1002; //ios
            }

            $updateSourceRes = utility_services::call('/user/info/UpdateUserSource', [$uid, $source]);
            if ($updateSourceRes->code) {
                SLog::fatal('update user source failed,uid[%d],source[%d]', $uid, $source);
            }

            $res = user_api::bindParterner($partnerInfo->parterner_id, $uid);
            empty($res) && interface_func::setMsg(1032);
        }
        user_api::loginByUid($uid) && interface_func::setData(utility_session::get()['user']);

        interface_func::setMsg(1);
    }
	
	/*
	 * 成长体系 获取成长值
	 * @params uid 
	 */
	public function pageUserLevel(){
		$this->v(['uid'=>1000]);
		$uid = $this->paramsInfo['params']['uid']; //= 835;
		$this->uidTokenValid($this->paramsInfo['token'], $uid);
		
		$day = date('Y-m-d',time());
		//是否签到
		$signInfo = user_api::getUserSignByDay($day,$uid);
		//签到天数
		$lastSign = user_api::getLastUserSign($uid);
		$yesterday= date('Y-m-d',time()-3600*24);
		if(!empty($lastSign) && !empty($signInfo)){
			$days = $signInfo->combo;
		}elseif(!empty($lastSign) && empty($signInfo)){
			if($lastSign->day != $yesterday ){
				$days = 0;
			}elseif($lastSign->day == $yesterday ){
				$days = $lastSign->combo;
			}
		}else{
			$days = 0;
		}
		
		//用户状态(1 学生 2 老师)
		$userType = user_api::checkSpecial($uid);
		//用户等级信息
		$userLevelRes = user_api::getUserLevel($uid);
		
		$regInfo  = course_api::listRegistration(array("uid"=>$uid));
		$lookPlan = user_api::getUserPlanStatCountByUid($uid);
		$studyReg = user_api::getUserStatByUid($uid);
		//学习时间
		$studyTime = 0;
		$finish    = 0;
		if(!empty($studyReg)){
			$studyTime = ceil(($studyReg->vt_live + $studyReg->vt_record)/3600);
		}
		//已学课程数
		if(!empty($regInfo->data)){
			foreach($regInfo->data as $val){
				$myCourseId[] = $val->cid;
				$myClassId[]  = $val->class_id;
			}
			$query = [
				'course_id'=>implode(',',$myCourseId),'class_id'=>implode(',',$myClassId),
				'status'=>'1,2,3','course_type'=>'1,2'
			];
			$seekPlan = seek_api::seekPlan(array('q'=>$query,'p'=>1,'pl'=>1000));
			
			if(!empty($seekPlan->data)){
				foreach($seekPlan->data as $v){
					$planIdArr[] = $v->plan_id;
				}
				$finish = user_api::getUserPlanStatCountByPid($uid,$planIdArr);
			}
		}
		
		$teacher = array();
		if($userType == 2){
			$params = [
				'q' => ['teacher_id'=>$uid],
				'f' => ['student_count','course_count','totaltime','avg_score']
			];
			$teacherRes = seek_api::seekTeacher($params);
			if(!empty($teacherRes->data)){
				$teacherInfo = $teacherRes->data[0];
				$teacher = [
					"students"       => $teacherInfo->student_count,
					"teacherCourses" => $teacherInfo->course_count,
					"teachingTime"   => number_format($teacherInfo->totaltime/3600,1),
					"score"          => ($teacherInfo->avg_score/10)
				];
			}
		}
		
		$student = [
			"day"       => $days,
			"ex"        => !empty($userLevelRes->score) ? $userLevelRes->score : 0, 
			"level"     => !empty($userLevelRes->fk_level) ? $userLevelRes->fk_level : '1',
			"levelName" => !empty($userLevelRes->title) ? $userLevelRes->title : '书生1',
			"status"    => !empty($signInfo) ? 1 : 0,
			"grow"      => ($days<5) ? 2 : 7,
			"courses"   => $regInfo->total,
			"finish"    => $finish,
			"learningTime" => $studyTime,
			"videoTimes"   => $lookPlan,
		];
		
		$data = array_merge($student,$teacher);
		$this->setData($data);
	}
	
	/*
	 * 签到接口
	 * @params uid
	 */
	public function pageSign(){
		$this->v(['uid'=>1000]);
		$uid = $this->paramsInfo['params']['uid'];
		$this->uidTokenValid($this->paramsInfo['token'], $uid);
		
		$day = date('Y-m-d',time());
		$signInfo = user_api::getUserSignByDay($day,$uid);
		if(empty($signInfo)){
			//执行签到
			$result = user_api::changeUserLevelAndScore($uid,'SIGN');
		}
		//用户等级信息
		$userLevelRes = user_api::getUserLevel($uid);
		
		//是否签到
		$isSign = (!empty($result->data) || !empty($signInfo)) ? 1 : 0;
		//距下个等级所需要的经验
		$nextEx    = 0;
		$allSort   = user_api::getUserAllSortByUid($uid);
		$userCount = user_api::getAllUserCount();
		if(empty($userCount)){
			$userCount = 0;
		}
		if(!empty($allSort)){
			$nextEx = $userCount-$allSort+1;
		}
		
		//签到天数
		$lastSign = user_api::getLastUserSign($uid);
		$yesterday= date('Y-m-d',time()-3600*24);
		if(!empty($lastSign) && !empty($signInfo)){
			$days = $signInfo->combo;
		}elseif(!empty($lastSign) && empty($signInfo)){
			if($lastSign->day != $yesterday ){
				$days = 0;
			}elseif($lastSign->day == $yesterday ){
				$days = $lastSign->combo;
			}
		}else{
			$days = 0;
		}
		
		$data = [
			"day"         =>$days,
			"ex"          =>!empty($userLevelRes->score) ? $userLevelRes->score : 0,
			"level"       =>!empty($userLevelRes->fk_level) ? $userLevelRes->fk_level : '1',
			"levelName"   =>!empty($userLevelRes->title) ? $userLevelRes->title : '1',
			"status"      =>$isSign,
			"grow"        =>($days<5) ? 2 : 7,
			"continueDay" => 5-$days,
			"extraEx"     => 7,
			"nextEx"      => $nextEx
		];
		
		$this->setData($data);
	}
	
	
	
	
	
	
	

}

